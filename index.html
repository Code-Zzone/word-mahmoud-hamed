<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø­Ø±Ø± Ø§Ù„Ø´Ø§Ù…Ù„ - Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* ========================================= */
        /* Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª */
        /* ========================================= */
        :root {
            --primary: #2e7d32; /* Ø£Ø®Ø¶Ø± Ù…Ø±ÙŠØ­ Ù„Ù„Ø¹ÙŠÙ† (Ø¥ÙƒØ³Ù„ Ø³ØªØ§ÙŠÙ„) */
            --bg: #f5f5f5;
            --border: #ccc;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding-top: 150px;
            direction: rtl;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª */
        .toolbar {
            position: fixed; top: 0; left: 0; right: 0;
            height: 130px; background: white;
            border-bottom: 3px solid var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex; gap: 10px; padding: 5px 20px;
            align-items: center; overflow-x: auto;
        }

        .group {
            display: flex; flex-direction: column; align-items: center;
            border-left: 1px solid #ddd; padding: 0 10px; min-width: max-content;
        }
        .group-title { font-size: 11px; color: #555; margin-bottom: 4px; font-weight: bold; }
        .row { display: flex; gap: 5px; align-items: center; margin-bottom: 4px; }

        button, select {
            padding: 5px 10px; border: 1px solid #ccc; background: #fff;
            cursor: pointer; border-radius: 4px; font-family: 'Cairo'; font-size: 13px;
            transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        button:hover { background: #e8f5e9; border-color: var(--primary); }
        button.active { background: #c8e6c9; border-color: var(--primary); }
        
        button.primary-btn { background: var(--primary); color: white; border: none; }
        button.danger-btn { color: #d32f2f; background: #ffebee; border-color: #ffcdd2; }
        button.calc-btn { background: #fff3e0; color: #e65100; border-color: #ffe0b2; }

        /* Ø§Ù„Ø£Ù„ÙˆØ§Ù† */
        .color-wrapper { position: relative; width: 32px; height: 32px; border: 1px solid #ccc; border-radius: 4px; overflow: hidden; display: flex; align-items: center; justify-content: center; font-weight: bold;}
        .color-wrapper input { position: absolute; left: -50%; top: -50%; width: 200%; height: 200%; cursor: pointer; opacity: 0; }
        .color-preview { width: 100%; height: 100%; position: absolute; z-index: 0; }
        .color-icon { position: relative; z-index: 1; pointer-events: none; text-shadow: 0 0 2px white; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„ */
        .workspace {
            display: flex; flex-direction: column; align-items: center; gap: 30px; padding-bottom: 50px;
        }
        .a4-page {
            width: 210mm; min-height: 297mm;
            background: white; padding: 20mm;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative; box-sizing: border-box;
        }
        .page-header {
            display: flex; justify-content: space-between; align-items: center;
            background: #455a64; color: white; padding: 5px 10px;
            border-radius: 5px 5px 0 0; font-size: 12px;
        }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        .editable-block { position: relative; border: 1px dashed transparent; margin-bottom: 5px; }
        .editable-block:hover { border-color: #bbb; }
        .block-tools { position: absolute; right: -35px; top: 0; display: none; flex-direction: column; gap: 2px;}
        .editable-block:hover .block-tools { display: flex; }
        .mini-btn { width: 25px; height: 25px; padding: 0; border-radius: 50%; }

        table { width: 100%; border-collapse: collapse; table-layout: fixed; margin: 0 auto; }
        th, td { border: 1px solid #999; padding: 5px; position: relative; word-wrap: break-word; }
        th { background-color: #eee; font-weight: bold; text-align: center; }

        /* Ø§Ù„ØªØ­Ø¯ÙŠØ¯ */
        .selected { background-color: rgba(46, 125, 50, 0.2) !important; outline: 2px solid var(--primary); z-index: 10; }
        .resizer { position: absolute; left: 0; top: 0; bottom: 0; width: 5px; cursor: col-resize; z-index: 20; }
        
        /* Ø§Ù„ØµÙˆØ± */
        .resizable-img-wrapper { display: inline-block; position: relative; vertical-align: middle; border: 1px solid transparent; }
        .resizable-img-wrapper:hover { border: 1px dashed var(--primary); }
        .resizable-img-wrapper img { display: block; max-width: 100%; }
        .img-handle { width: 12px; height: 12px; background: var(--primary); position: absolute; bottom: -6px; left: -6px; cursor: sw-resize; display: none; border-radius: 50%; }
        .resizable-img-wrapper:hover .img-handle { display: block; }

        @media print {
            .toolbar, .page-header, .block-tools, .img-handle { display: none !important; }
            .a4-page { box-shadow: none; margin: 0; width: 100%; height: auto; }
            .editable-block { border: none !important; }
        }
    </style>
</head>
<body>

    <!-- Toolbar -->
    <div class="toolbar">
        <input type="file" id="logoInput" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">

        <div class="group">
            <span class="group-title">Ø¥Ø¯Ø±Ø§Ø¬</span>
            <div class="row">
                <button onclick="addBlock('table')" class="primary-btn">â–¦ Ø¬Ø¯ÙˆÙ„</button>
                <button onclick="document.getElementById('logoInput').click()">ğŸ–¼ï¸ ØµÙˆØ±Ø©</button>
                <button onclick="addBlock('text')">ğŸ“ Ù†Øµ</button>
            </div>
            <div class="row">
                <button onclick="addBlock('heading')">H Ø¹Ù†ÙˆØ§Ù†</button>
                <button onclick="addPage()" style="background:#333; color:white;">ğŸ“„ ØµÙØ­Ø© +</button>
            </div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¬Ø¯ÙŠØ¯) -->
        <div class="group" style="background:#fffde7;">
            <span class="group-title">Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ¨ÙŠØ§Ù†Ø§Øª</span>
            <div class="row">
                <button onclick="calcSum('alert')" class="calc-btn" title="ÙŠØ¹Ø±Ø¶ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙÙŠ Ø±Ø³Ø§Ù„Ø©">âˆ‘ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
                <button onclick="calcSum('insert')" class="calc-btn" title="ÙŠØ¯Ø±Ø¬ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙÙŠ Ø§Ù„Ø®Ù„ÙŠØ© Ø§Ù„Ø£Ø®ÙŠØ±Ø©">ğŸ“ Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</button>
            </div>
            <div class="row">
                <button onclick="addTotalRow()" class="calc-btn" style="font-weight:bold;">â• ØµÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</button>
            </div>
        </div>

        <div class="group">
            <span class="group-title">ØªØ±Ù‚ÙŠÙ… ÙˆÙ‡ÙŠÙƒÙ„Ø©</span>
            <div class="row">
                <button onclick="execTable('addrow')">â• ØµÙ</button>
                <button onclick="execTable('addcol')">â• Ø¹Ù…ÙˆØ¯</button>
                <button onclick="autoNumber()" style="background:#e8f5e9;">ğŸ”¢ ØªØ±Ù‚ÙŠÙ…</button>
            </div>
            <div class="row">
                <button onclick="removeNumbering()" class="danger-btn" title="Ø­Ø°Ù Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªØ±Ù‚ÙŠÙ…">ğŸš« Ø­Ø°Ù Ø§Ù„ØªØ±Ù‚ÙŠÙ…</button>
                <button onclick="deleteFullTable()" class="danger-btn">ğŸ—‘ï¸ Ø¬Ø¯ÙˆÙ„</button>
            </div>
        </div>

        <div class="group" style="background:#e3f2fd;">
            <span class="group-title">Ø¯Ù…Ø¬ ÙˆØªØ­Ø¯ÙŠØ¯</span>
            <div class="row">
                <button onclick="mergeCells()">ğŸ”— Ø¯Ù…Ø¬</button>
                <button onclick="unmergeCells()">ğŸ’” ÙÙƒ</button>
            </div>
            <div class="row">
                <small style="font-size:10px; color:#1565c0;">(Ctrl + Ù†Ù‚Ø± Ù„Ù„ØªØ­Ø¯ÙŠØ¯)</small>
            </div>
        </div>

        <div class="group">
            <span class="group-title">ØªÙ†Ø³ÙŠÙ‚</span>
            <div class="row">
                <div class="color-wrapper" title="Ù„ÙˆÙ† Ø§Ù„Ù†Øµ">
                    <div class="color-preview" id="tp" style="background:black;"></div><span class="color-icon" style="color:white;">A</span>
                    <input type="color" onchange="applyColor('text',this.value); document.getElementById('tp').style.background=this.value;">
                </div>
                <div class="color-wrapper" title="Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ©">
                    <div class="color-preview" id="bp" style="background:yellow;"></div><span class="color-icon">ğŸ¨</span>
                    <input type="color" onchange="applyColor('bg',this.value); document.getElementById('bp').style.background=this.value;">
                </div>
                <button onclick="document.execCommand('bold')"><b>B</b></button>
            </div>
            <div class="row">
                <button onclick="align('right')">â¡ï¸</button>
                <button onclick="align('center')">âºï¸</button>
                <button onclick="align('left')">â¬…ï¸</button>
            </div>
        </div>
    </div>

    <!-- Workspace -->
    <div class="workspace" id="workspace">
        <div class="page-container" id="page1">
            <div class="page-header">
                <span>ØµÙØ­Ø© 1</span>
                <button onclick="printThisPage('page1')" class="primary-btn" style="padding:2px 8px; font-size:11px;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
            </div>
            <div class="a4-page">
                <div class="editable-block" contenteditable="true" style="text-align:center; padding:20px; color:#888;">
                    <p>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ù…Ù„ Ù‡Ù†Ø§...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===============================================
        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ø´Ø·
        // ===============================================
        let selectedCells = [];
        let activeTable = null;
        let lastClickedCell = null; // Ù„ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠÙ† Ù†ÙƒØªØ¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹

        document.addEventListener('click', function(e) {
            const cell = e.target.closest('td, th');
            if (!cell) return;
            
            activeTable = cell.closest('table');
            lastClickedCell = cell;

            if (e.ctrlKey || e.metaKey) {
                if (selectedCells.includes(cell)) {
                    cell.classList.remove('selected');
                    selectedCells = selectedCells.filter(c => c !== cell);
                } else {
                    cell.classList.add('selected');
                    selectedCells.push(cell);
                }
            } else {
                document.querySelectorAll('.selected').forEach(c => c.classList.remove('selected'));
                selectedCells = [cell];
                cell.classList.add('selected');
            }
        });

        // ===============================================
        // Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠ (Calculation Logic)
        // ===============================================
        
        // 1. Ø­Ø³Ø§Ø¨ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯ (Alert Ø£Ùˆ Insert)
        function calcSum(mode) {
            if (selectedCells.length < 1) return alert('Ø­Ø¯Ø¯ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… Ø£ÙˆÙ„Ø§Ù‹.');

            let sum = 0;
            let count = 0;
            selectedCells.forEach(c => {
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ù‚Ù… Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù† Ø¨Ø¬Ø§Ù†Ø¨Ù‡ Ù†Øµ (Ù…Ø«Ù„ 500 Ø¬.Ù…)
                const text = c.innerText.replace(/[^\d.-]/g, '');
                const val = parseFloat(text);
                if (!isNaN(val)) {
                    sum += val;
                    count++;
                }
            });

            if (count === 0) return alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙŠ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.');

            if (mode === 'alert') {
                alert(`Ù…Ø¬Ù…ÙˆØ¹ ${count} Ø®Ù„Ø§ÙŠØ§ Ù‡Ùˆ: ${sum}`);
            } else if (mode === 'insert') {
                // Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ Ø¢Ø®Ø± Ø®Ù„ÙŠØ© ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„ÙŠÙ‡Ø§ (ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø®Ø§Ø±Ø¬ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙˆÙ‚ Ø§Ù„Ø±Ù‚Ù…)
                if (lastClickedCell) {
                    lastClickedCell.innerText = sum;
                    // ØªÙ„ÙˆÙŠÙ† Ø®ÙÙŠÙ Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù†Ø§ØªØ¬
                    lastClickedCell.style.fontWeight = 'bold';
                    lastClickedCell.style.backgroundColor = '#e8f5e9';
                } else {
                    alert('Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙŠØ© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ ÙˆØ¶Ø¹ Ø§Ù„Ù†Ø§ØªØ¬ ÙÙŠÙ‡Ø§ Ø£ÙˆÙ„Ø§Ù‹.');
                }
            }
        }

        // 2. Ø¥Ø¶Ø§ÙØ© ØµÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        function addTotalRow() {
            if (!activeTable) return alert('Ø­Ø¯Ø¯ Ø¬Ø¯ÙˆÙ„Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹.');

            const row = activeTable.insertRow(-1); // ØµÙ ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
            row.style.fontWeight = 'bold';
            row.style.backgroundColor = '#eee';

            const colCount = activeTable.rows[0].cells.length;

            // Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¹Ù„Ù‰ ÙƒÙ„ Ø¹Ù…ÙˆØ¯
            for (let i = 0; i < colCount; i++) {
                const newCell = row.insertCell(i);
                newCell.style.border = '1px solid #999';
                newCell.contentEditable = true;

                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙˆØ¯
                let colSum = 0;
                let hasNumbers = false;
                
                // Ù†Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙˆØ§Ù„ØµÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                for (let r = 1; r < activeTable.rows.length - 1; r++) {
                    const cell = activeTable.rows[r].cells[i];
                    if (cell) {
                        const val = parseFloat(cell.innerText.replace(/[^\d.-]/g, ''));
                        if (!isNaN(val)) {
                            colSum += val;
                            hasNumbers = true;
                        }
                    }
                }

                if (hasNumbers) {
                    newCell.innerText = colSum;
                } else if (i === 0) {
                    newCell.innerText = 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ'; // ÙƒØªØ§Ø¨Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø¨Ù‡ Ø£Ø±Ù‚Ø§Ù…
                }
            }
        }

        // ===============================================
        // Ø§Ù„ØªØ±Ù‚ÙŠÙ… ÙˆØ¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ±Ù‚ÙŠÙ…
        // ===============================================
        function autoNumber() {
            if(!activeTable) return alert('Ø­Ø¯Ø¯ Ø¬Ø¯ÙˆÙ„Ø§Ù‹.');
            let idx = -1;
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯
            activeTable.querySelectorAll('th').forEach((th,i)=> { if(th.innerText.match(/Ù…|#/)) idx=i; });
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…ÙˆØ¯ Ø¬Ø¯ÙŠØ¯
            if(idx===-1) {
                for(let r of activeTable.rows) {
                    let c = r.insertCell(0);
                    if(r.rowIndex===0) c.outerHTML='<th style="width:40px">Ù…</th>';
                    else { c.style.textAlign='center'; c.style.fontWeight='bold'; c.contentEditable=true; c.style.border='1px solid #999'; }
                }
                idx=0; setTimeout(()=>initResizers(activeTable),50);
            }
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
            let n=1;
            for(let i=1; i<activeTable.rows.length; i++) {
                if(activeTable.rows[i].cells[idx]) activeTable.rows[i].cells[idx].innerText = n++;
            }
        }

        function removeNumbering() {
            if(!activeTable) return alert('Ø­Ø¯Ø¯ Ø¬Ø¯ÙˆÙ„Ø§Ù‹ Ù„Ø¥Ù„ØºØ§Ø¡ ØªØ±Ù‚ÙŠÙ…Ù‡.');
            let idx = -1;
            // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø¯Ù‚Ø© Ø¹Ù† Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªØ±Ù‚ÙŠÙ…
            activeTable.querySelectorAll('th').forEach((th,i)=> { 
                if(th.innerText.trim() === 'Ù…' || th.innerText.trim() === '#') idx=i; 
            });

            if (idx !== -1) {
                if(confirm('ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªØ±Ù‚ÙŠÙ…. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°ÙÙ‡ØŸ')) {
                    for(let r of activeTable.rows) {
                        if(r.cells[idx]) r.deleteCell(idx);
                    }
                }
            } else {
                alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ Ø¨Ø§Ø³Ù… "Ù…" Ø£Ùˆ "#". ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙˆØ¯ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø²Ø± "Ø­Ø°Ù Ø¹Ù…ÙˆØ¯".');
            }
        }

        // ===============================================
        // Ø§Ù„Ø¯Ù…Ø¬ ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„ØªÙ†Ø³ÙŠÙ‚ (Standard)
        // ===============================================
        function mergeCells() {
            if(selectedCells.length<2) return alert('Ø­Ø¯Ø¯ Ø®Ù„ÙŠØªÙŠÙ† Ø¨Ù€ Ctrl');
            const table = selectedCells[0].closest('table');
            if(!selectedCells.every(c=>c.closest('table')===table)) return;
            
            let minR=Infinity,maxR=-Infinity,minC=Infinity,maxC=-Infinity;
            selectedCells.forEach(c=>{
                minR=Math.min(minR,c.parentElement.rowIndex); maxR=Math.max(maxR,c.parentElement.rowIndex);
                minC=Math.min(minC,c.cellIndex); maxC=Math.max(maxC,c.cellIndex);
            });
            const target=selectedCells.find(c=>c.parentElement.rowIndex===minR && c.cellIndex===minC) || selectedCells[0];
            target.rowSpan = maxR-minR+1; target.colSpan = maxC-minC+1;
            selectedCells.forEach(c=> {if(c!==target) c.remove()});
            selectedCells=[target]; target.classList.add('selected');
        }

        function unmergeCells() {
            if(selectedCells.length!==1) return alert('Ø­Ø¯Ø¯ Ø®Ù„ÙŠØ© Ù…Ø¯Ù…ÙˆØ¬Ø©');
            const c=selectedCells[0]; const cs=c.colSpan;
            if(c.rowSpan===1 && cs===1) return;
            c.colSpan=1; c.rowSpan=1;
            for(let i=0; i<cs-1; i++) {
                let nc=c.parentElement.insertCell(c.cellIndex+1); nc.contentEditable=true; nc.style.border='1px solid #999';
            }
        }

        function applyColor(type, val) {
            if(selectedCells.length>0) selectedCells.forEach(c => c.style[type==='bg'?'backgroundColor':'color'] = val);
            else document.execCommand(type==='bg'?'hiliteColor':'foreColor', false, val);
        }

        function align(d) {
            if(activeTable) activeTable.style.textAlign=d;
            document.execCommand('justify'+(d==='right'?'Right':d==='left'?'Left':'Center'));
        }

        // ===============================================
        // Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø¬Ø¯Ø§ÙˆÙ„ØŒ ØµÙˆØ±ØŒ Ø·Ø¨Ø§Ø¹Ø©)
        // ===============================================
        function addBlock(type) {
            const p = document.querySelectorAll('.a4-page')[document.querySelectorAll('.a4-page').length-1];
            const d = document.createElement('div'); d.className='editable-block';
            d.innerHTML = `<div class="block-tools"><button class="mini-btn danger-btn" onclick="this.closest('.editable-block').remove()">X</button></div>`;
            if(type==='table') createResizableTable(d);
            else if(type==='heading') d.innerHTML+=`<h1 contenteditable="true" style="text-align:center;">Ø¹Ù†ÙˆØ§Ù†</h1>`;
            else d.innerHTML+=`<div contenteditable="true" style="padding:5px"><p>Ù†Øµ...</p></div>`;
            p.appendChild(d); d.scrollIntoView({behavior:'smooth'});
        }

        function createResizableTable(c) {
            const t = document.createElement('table');
            t.innerHTML = `<thead><tr><th style="width:50px">Ù…</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„Ø³Ø¹Ø±</th></tr></thead><tbody><tr><td>1</td><td></td><td></td></tr></tbody>`;
            t.querySelectorAll('td, th').forEach(c=>c.contentEditable=true); c.appendChild(t); initResizers(t);
        }
        function initResizers(t) {
            t.querySelectorAll('th').forEach(th=>{
                if(th.querySelector('.resizer')) return;
                const r=document.createElement('div'); r.className='resizer'; r.contentEditable=false; th.appendChild(r);
                let x=0,w=0; r.addEventListener('mousedown',e=>{x=e.clientX; w=parseInt(getComputedStyle(th).width); document.addEventListener('mousemove',mm); document.addEventListener('mouseup',mu);});
                const mm=e=>th.style.width=(w-(x-e.clientX))+'px'; const mu=()=>{document.removeEventListener('mousemove',mm); document.removeEventListener('mouseup',mu);}
            });
        }
        function execTable(a) {
            if(!activeTable) return alert('Ø­Ø¯Ø¯ Ø¬Ø¯ÙˆÙ„Ø§Ù‹');
            if(a==='addrow') { let r=activeTable.insertRow(-1); for(let i=0;i<activeTable.rows[0].cells.length;i++){let c=r.insertCell(); c.contentEditable=true; c.style.border='1px solid #999';} }
            if(a==='addcol') { for(let r of activeTable.rows){let c=r.insertCell(-1); c.contentEditable=true; c.style.border='1px solid #999'; if(r.rowIndex===0){c.outerHTML='<th>Ø¬Ø¯ÙŠØ¯</th>'; setTimeout(()=>initResizers(activeTable),50);}} }
            if(a==='delrow' && selectedCells.length) selectedCells[0].parentElement.remove();
            if(a==='delcol' && selectedCells.length) { let idx=selectedCells[0].cellIndex; for(let r of activeTable.rows) if(r.cells[idx]) r.deleteCell(idx); }
        }
        function deleteFullTable() { if(activeTable && confirm('Ø­Ø°Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„ØŸ')) activeTable.closest('.editable-block').remove(); }
        
        function handleImageUpload(i) {
            if(i.files[0]) { const r=new FileReader(); r.onload=e=>{
                const p=document.querySelectorAll('.a4-page')[document.querySelectorAll('.a4-page').length-1];
                const d=document.createElement('div'); d.className='editable-block'; d.style.textAlign='center';
                d.innerHTML=`<div class="block-tools"><button class="mini-btn danger-btn" onclick="this.closest('.editable-block').remove()">X</button></div><div class="resizable-img-wrapper" style="width:200px"><img src="${e.target.result}"><div class="img-handle"></div></div>`;
                p.appendChild(d);
                const h=d.querySelector('.img-handle'), w=d.querySelector('.resizable-img-wrapper');
                let sx,sw; h.addEventListener('mousedown',e=>{e.preventDefault(); e.stopPropagation(); sx=e.clientX; sw=parseInt(getComputedStyle(w).width); document.addEventListener('mousemove',dm); document.addEventListener('mouseup',sm);});
                const dm=e=>w.style.width=(sw+(sx-e.clientX))+'px'; const sm=()=>{document.removeEventListener('mousemove',dm); document.removeEventListener('mouseup',sm);}
            }; r.readAsDataURL(i.files[0]); } i.value='';
        }
        
        let pn=1;
        function addPage() {
            pn++; const id='p'+pn; const d=document.createElement('div'); d.id=id; d.className='page-container';
            d.innerHTML=`<div class="page-header"><span>ØµÙØ­Ø© ${pn}</span><button onclick="printThisPage('${id}')" class="primary-btn" style="padding:2px">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button></div><div class="a4-page"><div class="editable-block" contenteditable="true"><p>...</p></div></div>`;
            document.getElementById('workspace').appendChild(d); d.scrollIntoView({behavior:'smooth'});
        }
        function printThisPage(id) {
            document.querySelectorAll('.page-container').forEach(c=>c.style.display='none');
            const t=document.getElementById(id); t.style.display='block'; t.style.position='absolute'; t.style.top='0'; t.style.width='100%';
            window.print(); setTimeout(()=>{document.querySelectorAll('.page-container').forEach(c=>{c.style.display='block'; c.style.position='relative';})},500);
        }
    </script>
</body>
</html>
