<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محرر فائق - تحكم كامل وجودة طباعة عالية</title>
    <!-- مكتبات JavaScript الخارجية لإنشاء PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* ----------------------------------- */
        /* التنسيق الأساسي والواجهة */
        /* ----------------------------------- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
            direction: rtl; 
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            padding: 30px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        h1, h2, h3, th {
            outline: none; /* إزالة خط التركيز الافتراضي للتحرير المباشر */
        }

        /* ----------------------------------- */
        /* شريط التحكم (الأزرار) */
        /* ----------------------------------- */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 5px;
        }

        button, select {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: bold;
        }
        button:hover { background-color: #0056b3; }

        .print-controls button { background-color: #28a745; }
        .print-controls button:hover { background-color: #1e7e34; }

        /* ----------------------------------- */
        /* محرر النصوص والجداول */
        /* ----------------------------------- */
        .editor-section {
            margin-bottom: 30px;
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 5px;
            background-color: #fff;
        }

        .text-editor {
            min-height: 300px;
            border: 1px solid #ddd;
            padding: 20px;
            font-size: 16px;
            line-height: 1.6;
            outline: none;
            margin-top: 10px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            min-width: 600px; 
        }

        .data-table th, .data-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: right;
            min-width: 100px; 
            outline: none;
        }
        
        /* ----------------------------------- */
        /* تنسيق الطباعة (المحور الأساسي للطلب) */
        /* ----------------------------------- */
        
        /* 1. إعدادات الطباعة الافتراضية */
        @media print {
            /* إخفاء جميع عناصر التحكم */
            .no-print, .controls, .toolbar, .excel-controls { display: none !important; }
            /* إزالة الظلال والحدود للمحتوى الرئيسي */
            body, .container { background-color: white !important; padding: 0 !important; margin: 0 !important; box-shadow: none !important; }
            .text-editor, .sheet-section { border: none !important; min-height: initial !important; }
            /* جودة خط عالية للطباعة */
            * { color: #000 !important; background: none !important; text-shadow: none !important; box-shadow: none !important; }
            /* ضمان ظهور حدود الجدول بوضوح */
            .data-table th, .data-table td { border: 1px solid #000 !important; padding: 5px !important; }
        }

        /* 2. التحكم في الطباعة حسب الجزء المحدد */
        
        /* عند طباعة الجدول فقط */
        body.print-table-only .text-editor-container { display: none; }
        body.print-table-only .sheet-section { margin-top: 0; padding-top: 0; }

        /* عند طباعة المقال فقط */
        body.print-text-only .sheet-section { display: none; }
        body.print-text-only .text-editor-container { margin-bottom: 0; padding-bottom: 0; }
        
        /* 3. التحكم في اتجاه الورقة (اقتراح للمتصفح) */
        /* يمكن للمستخدم إلغاء هذا في نافذة الطباعة */
        body.print-landscape @page { size: landscape; }

    </style>
</head>
<body>

    <div class="container" id="printable-content">
        <h1 contenteditable="true">محرر فائق - جودة طباعة عالية وتحكم كامل</h1>

        <!-- ----------------------------------- -->
        <!-- قسم التحكم والأزرار العامة والطباعة -->
        <!-- ----------------------------------- -->
        <div class="controls no-print">
            <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 5px; color: #007bff; width: 100%;">خيارات الطباعة والتحميل</div>
            
            <button onclick="printAll()">طباعة المحتوى كاملاً</button>
            <button onclick="downloadPDF()">تحميل كملف PDF</button>
            <button onclick="saveHTML()">حفظ كملف HTML</button>
            
            <button class="print-controls" onclick="printTextOnly()">طباعة المقال/النصوص فقط</button>
            <button class="print-controls" onclick="printTableOnly()">طباعة الجدول فقط</button>

            <!-- خيار التحكم في اتجاه الورقة -->
            <select onchange="setPrintOrientation(this.value)">
                <option value="portrait">اتجاه الورقة: عمودي (Portrait)</option>
                <option value="landscape">اتجاه الورقة: أفقي (Landscape)</option>
            </select>
        </div>

        <!-- ----------------------------------- -->
        <!-- محرر النصوص (بديل Word) -->
        <!-- ----------------------------------- -->
        <div class="editor-section text-editor-container">
            <h2 contenteditable="true">محرر النصوص والمقالات (Word البديل)</h2>
            
            <div class="toolbar no-print">
                <!-- أزرار تنسيق النص (تم الاحتفاظ بها) -->
                <button onclick="formatDoc('bold')">B</button>
                <button onclick="formatDoc('italic')">I</button>
                <button onclick="formatDoc('underline')">U</button>
                <select onchange="formatDoc('fontSize', this.value); this.value='';" title="حجم الخط">
                    <option value="" selected disabled>حجم</option>
                    <option value="3">12pt</option>
                    <option value="5">16pt</option>
                    <option value="7">24pt</option>
                </select>
                <input type="color" onchange="formatDoc('foreColor', this.value)" title="لون الخط">
            </div>
            
            <div id="textEditor" class="text-editor" contenteditable="true">
                <p>هنا يمكنك كتابة مقالاتك أو مستنداتك. الطباعة منفردة لهذا الجزء ستخفي الجدول.</p>
            </div>
        </div>

        <!-- ----------------------------------- -->
        <!-- محرر الجداول (بديل Excel) -->
        <!-- ----------------------------------- -->
        <div class="editor-section sheet-section">
            <h2 contenteditable="true">محرر الجداول (Excel البديل)</h2>
            <p style="font-size: 14px; color: #6c757d;">(للتحديد المتعدد لدمج الخلايا: استخدم مفتاح **Ctrl** أو **Command** مع النقر.)</p>
            
            <div class="excel-controls no-print">
                <button onclick="addRow()">إضافة صف</button>
                <button onclick="addColumn()">إضافة عمود</button>
                <button style="background-color: #dc3545;" onclick="removeSelectedRow()">حذف الصف المحدد</button>
                <button style="background-color: #ffc107; color: #333;" onclick="mergeCells()">دمج الخلايا المحددة</button>
                <button onclick="calculateSum()">حساب المجموع</button>
            </div>
            
            <table class="data-table" id="dataTable">
                <thead>
                    <tr>
                        <th contenteditable="true">المنتج</th>
                        <th contenteditable="true">الكمية</th>
                        <th contenteditable="true">السعر (قابل للتحرير)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td contenteditable="true">كمبيوتر</td>
                        <td contenteditable="true">10</td>
                        <td contenteditable="true">4500</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // -----------------------------------
        // وظائف الطباعة والتحكم في الشكل
        // -----------------------------------
        const body = document.body;

        // دالة لتحديد اتجاه الورقة (يؤثر على CSS @page)
        function setPrintOrientation(orientation) {
            if (orientation === 'landscape') {
                body.classList.add('print-landscape');
            } else {
                body.classList.remove('print-landscape');
            }
        }
        
        // الطباعة الكاملة
        function printAll() {
            body.classList.remove('print-table-only', 'print-text-only');
            window.print();
        }

        // طباعة المقال/النص فقط
        function printTextOnly() {
            body.classList.remove('print-table-only');
            body.classList.add('print-text-only');
            window.print();
            // تأخير بسيط لإعطاء المتصفح وقتًا لإنهاء الطباعة ثم تنظيف الكلاس
            setTimeout(() => body.classList.remove('print-text-only'), 100); 
        }

        // طباعة الجدول فقط
        function printTableOnly() {
            body.classList.remove('print-text-only');
            body.classList.add('print-table-only');
            window.print();
            // تأخير بسيط لإعطاء المتصفح وقتًا لإنهاء الطباعة ثم تنظيف الكلاس
            setTimeout(() => body.classList.remove('print-table-only'), 100); 
        }

        // -----------------------------------
        // وظائف التحرير والتنسيق (مختصرة للاستكمال)
        // -----------------------------------
        function formatDoc(command, value) {
            document.execCommand(command, false, value);
        }
        
        // (وظائف الجداول - تم الاحتفاظ بها من الكود السابق)
        const dataTable = document.getElementById('dataTable');
        let selectedCells = []; 
        
        dataTable.addEventListener('click', function(event) {
            const cell = event.target.closest('td, th');
            if (!cell) return;
            selectedCells.forEach(c => c.classList.remove('selected-cell', 'multi-selected-cell'));
            if (!event.ctrlKey && !event.metaKey) {
                selectedCells = [cell];
            } else {
                const index = selectedCells.indexOf(cell);
                if (index > -1) { selectedCells.splice(index, 1); } 
                else { selectedCells.push(cell); }
            }
            selectedCells.forEach(c => c.classList.add(selectedCells.length === 1 ? 'selected-cell' : 'multi-selected-cell'));
        });

        function addRow() { /* ... كود إضافة صف ... */
            const tBody = dataTable.tBodies[0];
            const colCount = dataTable.rows[0].cells.length;
            const newRow = tBody.insertRow(-1); 
            for (let i = 0; i < colCount; i++) {
                const newCell = newRow.insertCell(i);
                newCell.contentEditable = 'true';
                newCell.textContent = '';
            }
        }
        function addColumn() { /* ... كود إضافة عمود ... */
            const headerRow = dataTable.tHead.rows[0];
            const newHeader = document.createElement('th');
            newHeader.textContent = `عمود جديد`;
            newHeader.contentEditable = 'true';
            headerRow.appendChild(newHeader);
            const bodyRows = dataTable.tBodies[0].rows;
            for (let i = 0; i < bodyRows.length; i++) {
                const newCell = bodyRows[i].insertCell(-1); 
                newCell.contentEditable = 'true';
                newCell.textContent = '';
            }
        }
        function removeSelectedRow() { /* ... كود حذف صف ... */
            if (selectedCells.length !== 1 || selectedCells[0].tagName === 'TH') {
                alert('الرجاء النقر على خلية واحدة في الصف (غير العنوان) المراد حذفه.');
                return;
            }
            if (confirm('هل أنت متأكد من حذف هذا الصف؟')) {
                selectedCells[0].parentElement.remove();
                selectedCells = [];
            }
        }
        function mergeCells() { /* ... كود دمج الخلايا ... */
             if (selectedCells.length < 2) {
                alert('الرجاء تحديد خليتين أو أكثر للدمج.');
                return;
            }
            const rows = Array.from(new Set(selectedCells.map(c => c.parentElement.rowIndex)));
            const cols = Array.from(new Set(selectedCells.map(c => c.cellIndex)));
            if (rows.length === 0 || cols.length === 0) return;
            const firstCell = dataTable.rows[Math.min(...rows)].cells[Math.min(...cols)];
            
            if (!firstCell) return;
            
            firstCell.setAttribute('rowspan', rows.length);
            firstCell.setAttribute('colspan', cols.length);
            
            selectedCells.filter(c => c !== firstCell).forEach(cell => cell.remove());
            selectedCells = [firstCell];
            firstCell.classList.remove('multi-selected-cell');
            firstCell.classList.add('selected-cell');
            alert(`تم دمج الخلايا بنجاح: ${rows.length} صفوف و ${cols.length} أعمدة.`);
        }
        function calculateSum() { /* ... كود حساب المجموع ... */
            if (selectedCells.length === 0) {
                alert('الرجاء تحديد الخلايا التي تحتوي على الأرقام لحساب مجموعها.');
                return;
            }
            let sum = 0;
            let invalidCount = 0;
            selectedCells.forEach(cell => {
                const value = parseFloat(cell.textContent.trim());
                if (!isNaN(value)) { sum += value; } 
                else if (cell.textContent.trim() !== '') { invalidCount++; }
            });
            let message = `مجموع الخلايا المحددة هو: ${sum}`;
            if (invalidCount > 0) {
                message += `\n(تم تجاهل ${invalidCount} خلية غير رقمية)`;
            }
            alert(message);
        }

        // وظائف الحفظ والـ PDF (كما في الكود السابق)
        function saveHTML() { /* ... كود حفظ HTML ... */
            const content = document.getElementById('printable-content').innerHTML;
            const fullHtml = `<html><head><title>مستند محفوظ</title></head><body dir="rtl">${content}</body></html>`;
            const blob = new Blob([fullHtml], { type: 'text/html;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'مستند_محرر_شامل.html';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        async function downloadPDF() { /* ... كود تحميل PDF ... */
            const { jsPDF } = window.jspdf;
            const content = document.getElementById('printable-content');
            
            // إخفاء الأزرار مؤقتاً قبل أخذ لقطة الشاشة
            const controls = document.querySelectorAll('.no-print');
            controls.forEach(c => c.style.display = 'none');
            
            const canvas = await html2canvas(content, { scale: 3, useCORS: true }); // زيادة الـ Scale لـ 3 لزيادة الدقة
            controls.forEach(c => c.style.display = 'flex'); 

            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4'); 
            const imgWidth = 210; 
            const pageHeight = 297; 
            const imgHeight = canvas.height * imgWidth / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;

            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }

            pdf.save('مستند_محرر_شامل.pdf');
        }
    </script>
</body>
</html>
