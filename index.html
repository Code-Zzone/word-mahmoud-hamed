<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ø±Ø± Ù…ØªÙ‚Ø¯Ù… ÙˆØ´Ø§Ù…Ù„ - Ø¨Ø¯ÙŠÙ„ Excel Ùˆ Word</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* ----------------------------------- */
        /* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø© */
        /* ----------------------------------- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
            direction: rtl; 
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            padding: 30px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        /* Ø¬Ø¹Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ­Ø±ÙŠØ± */
        h1, h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            text-align: center;
            outline: none;
        }
        
        /* ----------------------------------- */
        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­ÙƒÙ… (Ø§Ù„Ø£Ø²Ø±Ø§Ø±) */
        /* ----------------------------------- */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 5px;
        }

        button, select {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: bold;
        }

        button:hover {
            background-color: #0056b3;
        }

        /* ----------------------------------- */
        /* Ù…Ø­Ø±Ø± Ø§Ù„Ù†ØµÙˆØµ (Word Ø§Ù„Ø¨Ø¯ÙŠÙ„) */
        /* ----------------------------------- */
        .editor-section {
            margin-bottom: 30px;
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 5px;
            background-color: #fff;
        }

        .text-editor {
            min-height: 300px;
            border: 1px solid #ddd;
            padding: 20px;
            font-size: 16px;
            line-height: 1.6;
            outline: none;
            margin-top: 10px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .toolbar button, .toolbar select {
            background-color: #6c757d;
            padding: 5px 10px;
            font-size: 14px;
            margin-left: 5px;
        }
        
        /* ----------------------------------- */
        /* Ù…Ø­Ø±Ø± Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ (Excel Ø§Ù„Ø¨Ø¯ÙŠÙ„) */
        /* ----------------------------------- */
        .sheet-section {
            overflow-x: auto; 
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            min-width: 600px; 
        }

        .data-table th, .data-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: right; /* Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© */
            min-width: 100px; 
            outline: none;
        }

        .data-table th {
            background-color: #e9ecef;
            color: #333;
        }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø®Ù„Ø§ÙŠØ§ */
        .align-left { text-align: left !important; }
        .align-center { text-align: center !important; }
        .align-right { text-align: right !important; }

        /* ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ */
        .selected-cell {
            background-color: #ffc107 !important;
            outline: 2px solid #007bff;
        }
        .multi-selected-cell {
            background-color: #ffc10750 !important;
        }
        .excel-controls button {
            background-color: #28a745;
        }
        
        /* ----------------------------------- */
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (ÙŠØ¬Ø¨ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©) */
        /* ----------------------------------- */
        @media print {
            body { background-color: white !important; padding: 0; }
            /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø© */
            .controls:not(.print-temp), .toolbar:not(.print-temp), .excel-controls:not(.print-temp), .no-print:not(.print-temp) { 
                display: none !important; 
            }
            .container { box-shadow: none !important; padding: 0 !important; margin: 0 !important; max-width: 100% !important; }
            .text-editor, .sheet-section { border: none !important; min-height: initial !important; }
            /* Ø¥Ø¸Ù‡Ø§Ø± Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
            .data-table th, .data-table td { border: 1px solid #000 !important; padding: 5px !important; }
        }
    </style>
</head>
<body>

    <div class="container" id="printable-content">
        <h1 contenteditable="true">Ù…Ø­Ø±Ø± Ù…ØªÙ‚Ø¯Ù… ÙˆØ´Ø§Ù…Ù„ (Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ­Ø±ÙŠØ±)</h1>

        <div class="controls no-print">
            <button onclick="printAllContent()">**Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©:** Ø§Ø·Ø¨Ø¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</button>
            <button onclick="downloadPDF()">**Ø²Ø± ØªØ­Ù…ÙŠÙ„ PDF:** Ø­Ù…Ù„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ ÙƒÙ…Ù„Ù PDF</button>
            <button onclick="saveHTML()">**Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù:** Ø­ÙØ¸ ÙƒÙ…Ù„Ù HTML Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹</button>
        </div>

        <div class="editor-section" id="text-section">
            <h2 contenteditable="true">Ù…Ø­Ø±Ø± Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ù…Ù‚Ø§Ù„Ø§Øª (Word Ø§Ù„Ø¨Ø¯ÙŠÙ„)</h2>
            
            <div class="toolbar no-print">
                <button onclick="formatDoc('bold')">**B**</button>
                <button onclick="formatDoc('italic')">_I_</button>
                <button onclick="formatDoc('underline')">U</button>
                <button onclick="formatDoc('justifyLeft')">â¬…ï¸ Ù…Ø­Ø§Ø°Ø§Ø© Ù„Ù„ÙŠØ³Ø§Ø±</button>
                <button onclick="formatDoc('justifyCenter')">**ÙˆØ³Ø·**</button>
                <button onclick="formatDoc('justifyRight')">Ù…Ø­Ø§Ø°Ø§Ø© Ù„Ù„ÙŠÙ…ÙŠÙ† â¡ï¸</button>
                <button onclick="formatDoc('insertUnorderedList')">â€¢ Ù‚Ø§Ø¦Ù…Ø© Ù…Ù†Ù‚Ø·Ø©</button>
                <select onchange="formatDoc('fontSize', this.value); this.value='';" title="Ø­Ø¬Ù… Ø§Ù„Ø®Ø·">
                    <option value="" selected disabled>Ø­Ø¬Ù…</option>
                    <option value="3">ØµØºÙŠØ±</option>
                    <option value="5">Ù…ØªÙˆØ³Ø·</option>
                    <option value="7">ÙƒØ¨ÙŠØ±</option>
                </select>
                <input type="color" onchange="formatDoc('foreColor', this.value)" title="Ù„ÙˆÙ† Ø§Ù„Ø®Ø·">
                <input type="color" onchange="formatDoc('backColor', this.value)" title="Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ©">
                <button style="background-color: #009688;" onclick="printSpecificSection('text-section')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ù‚Ø³Ù… Ø§Ù„Ù†ØµÙˆØµ ÙÙ‚Ø·</button>
            </div>
            
            <div id="textEditor" class="text-editor" contenteditable="true">
                <h3>Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØ±Ø¹ÙŠ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ­Ø±ÙŠØ± Ø£ÙŠØ¶Ø§Ù‹.</h3>
                <p style="text-align: center;">ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Øµ Ø¨Ø£ÙŠ Ø´ÙƒÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø£Ø¹Ù„Ø§Ù‡. **Ø¬Ø±Ø¨ Ø§Ù„Ø¢Ù† Ø²Ø± Ø§Ù„ØªÙˆØ³ÙŠØ· Ø§Ù„Ø¬Ø¯ÙŠØ¯!**</p>
                <ul>
                    <li>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Enter Ù„Ø¨Ø¯Ø¡ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯.</li>
                    <li>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø®ØªØ§Ø±.</li>
                </ul>
            </div>
        </div>

        <div class="editor-section sheet-section" id="sheet-section">
            <h2 contenteditable="true">Ù…Ø­Ø±Ø± Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ (Excel Ø§Ù„Ø¨Ø¯ÙŠÙ„)</h2>
            <p style="font-size: 14px; color: #6c757d;">(Ù„Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ Ù„Ø¯Ù…Ø¬ Ø§Ù„Ø®Ù„Ø§ÙŠØ§: Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙØªØ§Ø­ **Ctrl** Ø£Ùˆ **Command** Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø±.)</p>
            
            <div class="excel-controls no-print">
                <button onclick="addRow()">â• Ø¥Ø¶Ø§ÙØ© ØµÙ</button>
                <button onclick="addColumn()">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯</button>
                <button style="background-color: #dc3545;" onclick="removeSelectedRow()">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ØµÙ Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
                <button style="background-color: #dc3545;" onclick="removeSelectedColumn()">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
                <button style="background-color: #ffc107; color: #333;" onclick="mergeCells()">ğŸ”— Ø¯Ù…Ø¬ Ø§Ù„Ø®Ù„Ø§ÙŠØ§</button>
                <button style="background-color: #ffc107; color: #333;" onclick="unmergeCell()">ğŸ’” Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯Ù…Ø¬</button>
                <button onclick="calculateSum()">âˆ‘ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</button>

                <button style="background-color: #17a2b8;" onclick="alignCell('left')">Ù…Ø­Ø§Ø°Ø§Ø© Ù„Ù„ÙŠØ³Ø§Ø±</button>
                <button style="background-color: #17a2b8;" onclick="alignCell('center')">**ØªÙˆØ³ÙŠØ·**</button>
                <button style="background-color: #17a2b8;" onclick="alignCell('right')">Ù…Ø­Ø§Ø°Ø§Ø© Ù„Ù„ÙŠÙ…ÙŠÙ†</button>
                <button style="background-color: #009688;" onclick="printSpecificSection('sheet-section')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙÙ‚Ø·</button>
            </div>
            
            <table class="data-table" id="dataTable">
                <thead>
                    <tr>
                        <th contenteditable="true">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† 1 (ÙƒÙ…ÙŠØ©)</th>
                        <th contenteditable="true">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† 2 (Ø§Ù„Ø³Ø¹Ø±)</th>
                        <th contenteditable="true">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† 3 (Ø§Ù„Ù…Ù†ØªØ¬)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td contenteditable="true">100</td>
                        <td contenteditable="true">250</td>
                        <td contenteditable="true" class="align-right">Ù…Ù†ØªØ¬ Ø£</td>
                    </tr>
                    <tr>
                        <td contenteditable="true">400</td>
                        <td contenteditable="true">500</td>
                        <td contenteditable="true" class="align-right">Ù…Ù†ØªØ¬ Ø¨</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // -----------------------------------
        // ÙˆØ¸Ø§Ø¦Ù ØªØ­Ø±ÙŠØ± Ø§Ù„Ù†ØµÙˆØµ (Word)
        // -----------------------------------
        function formatDoc(command, value) {
            document.execCommand(command, false, value);
        }

        // -----------------------------------
        // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ (Excel) - (ØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠØŒ ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø¬ÙŠØ¯)
        // -----------------------------------

        const dataTable = document.getElementById('dataTable');
        let selectedCells = []; // Ù„ØªØªØ¨Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯

        // ÙˆØ¸ÙŠÙØ© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ (ØªØ³Ù…Ø­ Ø¨ØªØ­Ø¯ÙŠØ¯ Ù…ØªØ¹Ø¯Ø¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ctrl/Cmd) 
        dataTable.addEventListener('click', function(event) {
            const cell = event.target.closest('td, th');
            if (!cell) return;

            if (!event.ctrlKey && !event.metaKey) {
                // ØªØ­Ø¯ÙŠØ¯ Ù…ÙØ±Ø¯ Ø¬Ø¯ÙŠØ¯ (Ù…Ø³Ø­ Ø§Ù„Ø³Ø§Ø¨Ù‚)
                selectedCells.forEach(c => c.classList.remove('selected-cell', 'multi-selected-cell'));
                selectedCells = [cell];
                cell.classList.add('selected-cell');
            } else {
                // ØªØ­Ø¯ÙŠØ¯/Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù…ØªØ¹Ø¯Ø¯
                if (selectedCells.includes(cell)) {
                    selectedCells = selectedCells.filter(c => c !== cell);
                    cell.classList.remove('selected-cell', 'multi-selected-cell');
                } else {
                    selectedCells.push(cell);
                    cell.classList.add('multi-selected-cell');
                    cell.classList.remove('selected-cell');
                }
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
            if (selectedCells.length === 1) {
                selectedCells[0].classList.add('selected-cell');
                selectedCells[0].classList.remove('multi-selected-cell');
            } else if (selectedCells.length > 1) {
                selectedCells.forEach(c => c.classList.add('multi-selected-cell'));
            }
        });

        // ÙˆØ¸ÙŠÙØ© Ù…Ø­Ø§Ø°Ø§Ø© Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ù„ÙŠØ©
        function alignCell(alignment) {
            const alignClass = `align-${alignment}`;
            if (selectedCells.length === 0) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø®Ù„ÙŠØ© ÙˆØ§Ø­Ø¯Ø© Ø£Ùˆ Ø£ÙƒØ«Ø± Ù„Ù„Ù…Ø­Ø§Ø°Ø§Ø©.');
                return;
            }

            selectedCells.forEach(cell => {
                cell.classList.remove('align-left', 'align-center', 'align-right');
                cell.classList.add(alignClass);
            });
        }
        
        // ... (Ø¨Ù‚ÙŠØ© Ø¯ÙˆØ§Ù„ Excel: addRow, addColumn, removeSelectedRow, removeSelectedColumn, mergeCells, unmergeCell, calculateSum) ...
        // (ØªÙ… Ø­Ø°ÙÙ‡Ø§ Ù…Ù† Ø§Ù„Ø±Ø¯ Ù‡Ù†Ø§ Ù„Ù„Ø§Ø®ØªØµØ§Ø±ØŒ Ù„ÙƒÙ†Ù‡Ø§ Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙˆÙ‚)
        function addRow() {
            const tBody = dataTable.tBodies[0];
            const colCount = dataTable.rows[0].cells.length;
            const newRow = tBody.insertRow(-1); 
            for (let i = 0; i < colCount; i++) {
                const newCell = newRow.insertCell(i);
                newCell.contentEditable = 'true';
                newCell.textContent = '';
                newCell.classList.add('align-right'); 
            }
        }

        function addColumn() {
            const headerRow = dataTable.tHead.rows[0];
            const newHeader = document.createElement('th');
            newHeader.textContent = `Ø¹Ù…ÙˆØ¯ Ø¬Ø¯ÙŠØ¯`;
            newHeader.contentEditable = 'true';
            headerRow.appendChild(newHeader);

            const bodyRows = dataTable.tBodies[0].rows;
            for (let i = 0; i < bodyRows.length; i++) {
                const newCell = bodyRows[i].insertCell(-1); 
                newCell.contentEditable = 'true';
                newCell.textContent = '';
                newCell.classList.add('align-right'); 
            }
        }
        
        function removeSelectedRow() {
            if (selectedCells.length !== 1 || selectedCells[0].tagName === 'TH') {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø®Ù„ÙŠØ© ÙˆØ§Ø­Ø¯Ø© ÙÙŠ Ø§Ù„ØµÙ (ØºÙŠØ± Ø§Ù„Ø¹Ù†ÙˆØ§Ù†) Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­Ø°ÙÙ‡.');
                return;
            }
            const selectedRow = selectedCells[0].parentElement;
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØµÙØŸ')) {
                selectedRow.remove();
                selectedCells = [];
            }
        }

        function removeSelectedColumn() {
            if (selectedCells.length !== 1) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø®Ù„ÙŠØ© ÙˆØ§Ø­Ø¯Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­Ø°ÙÙ‡.');
                return;
            }

            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ')) {
                const columnIndex = selectedCells[0].cellIndex;
                dataTable.tHead.rows[0].deleteCell(columnIndex);
                const bodyRows = dataTable.tBodies[0].rows;
                for (let i = 0; i < bodyRows.length; i++) {
                    bodyRows[i].deleteCell(columnIndex);
                }
                selectedCells = [];
            }
        }
        
        function mergeCells() {
            if (selectedCells.length < 2) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø®Ù„ÙŠØªÙŠÙ† Ø£Ùˆ Ø£ÙƒØ«Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙØªØ§Ø­ Ctrl/Command Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø± Ù„Ù„Ø¯Ù…Ø¬.');
                return;
            }
            const rows = Array.from(new Set(selectedCells.map(c => c.parentElement.rowIndex)));
            const cols = Array.from(new Set(selectedCells.map(c => c.cellIndex)));

            if (rows.length === 0 || cols.length === 0) return;

            const rowSpan = rows.length;
            const colSpan = cols.length;

            const firstCell = dataTable.rows[Math.min(...rows)].cells[Math.min(...cols)];
            
            if (!firstCell) return;

            firstCell.setAttribute('rowspan', rowSpan);
            firstCell.setAttribute('colspan', colSpan);
            firstCell.classList.remove('multi-selected-cell');
            firstCell.classList.add('selected-cell');

            selectedCells.filter(c => c !== firstCell).forEach(cell => cell.remove());
            
            selectedCells = [firstCell];
            alert(`ØªÙ… Ø¯Ù…Ø¬ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø¨Ù†Ø¬Ø§Ø­: ${rowSpan} ØµÙÙˆÙ Ùˆ ${colSpan} Ø£Ø¹Ù…Ø¯Ø©.`);
        }
        
        function unmergeCell() {
            if (selectedCells.length !== 1) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø®Ù„ÙŠØ© Ø§Ù„Ù…Ø¯Ù…ÙˆØ¬Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ù„ØºØ§Ø¡ Ø¯Ù…Ø¬Ù‡Ø§.');
                return;
            }
            
            const cell = selectedCells[0];
            const rowSpan = parseInt(cell.getAttribute('rowspan') || 1);
            const colSpan = parseInt(cell.getAttribute('colspan') || 1);

            if (rowSpan <= 1 && colSpan <= 1) {
                alert('Ø§Ù„Ø®Ù„ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù„ÙŠØ³Øª Ù…Ø¯Ù…ÙˆØ¬Ø©.');
                return;
            }

            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø¯Ù…Ø¬ Ù‡Ø°Ù‡ Ø§Ù„Ø®Ù„ÙŠØ©ØŸ Ø³ÙŠØªÙ… Ø¥Ø¯Ø±Ø§Ø¬ Ø®Ù„Ø§ÙŠØ§ ÙØ§Ø±ØºØ© Ù…ÙƒØ§Ù† Ø§Ù„Ø¯Ù…Ø¬.')) {
                
                cell.removeAttribute('rowspan');
                cell.removeAttribute('colspan');
                
                const rowIndex = cell.parentElement.rowIndex;
                const colIndex = cell.cellIndex;

                for (let r = 0; r < rowSpan; r++) {
                    const row = dataTable.rows[rowIndex + r];
                    if (row) {
                        for (let c = 1; c < colSpan; c++) {
                            const newCell = row.insertCell(colIndex + 1);
                            newCell.contentEditable = 'true';
                            newCell.textContent = '';
                            newCell.classList.add('align-right'); 
                        }
                    }
                }
                selectedCells = [cell];
            }
        }
        
        function calculateSum() {
            if (selectedCells.length === 0) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¬Ù…ÙˆØ¹Ù‡Ø§.');
                return;
            }

            let sum = 0;
            let invalidCount = 0;

            selectedCells.forEach(cell => {
                const value = parseFloat(cell.textContent.trim());
                if (!isNaN(value)) {
                    sum += value;
                } else if (cell.textContent.trim() !== '') {
                    invalidCount++;
                }
            });
            
            let message = `Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù‡Ùˆ: ${sum}`;
            if (invalidCount > 0) {
                message += `\n(ØªÙ… ØªØ¬Ø§Ù‡Ù„ ${invalidCount} Ø®Ù„ÙŠØ© ØºÙŠØ± Ø±Ù‚Ù…ÙŠØ©)`;
            }

            alert(message);
        }

        // -----------------------------------
        // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„ (Ø§Ù„Ù…ÙØ­Ø³Ù‘Ù†Ø©)
        // -----------------------------------

        function printAllContent() {
             window.print();
        }

        /**
         * Ø·Ø¨Ø§Ø¹Ø© Ù‚Ø³Ù… Ù…Ø­Ø¯Ø¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø§ÙØ°Ø© Ù…Ø¤Ù‚ØªØ© Ù„Ø¶Ù…Ø§Ù† Ø¹Ø²Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©.
         * @param {string} sectionId - Ù…ÙØ¹Ø±Ù Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø§Ø¯ Ø·Ø¨Ø§Ø¹ØªÙ‡ (Ù…Ø«Ù„ 'text-section' Ø£Ùˆ 'sheet-section').
         */
        function printSpecificSection(sectionId) {
            const sectionToPrint = document.getElementById(sectionId);
            if (!sectionToPrint) {
                alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©.');
                return;
            }

            // 1. Ø§Ø³ØªØ®Ù„Ø§Øµ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø·Ø¨Ø§Ø¹ØªÙ‡
            const content = sectionToPrint.innerHTML;
            
            // 2. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ ØªÙ†Ø³ÙŠÙ‚Ø§Øª CSS (Ù…Ù‡Ù… Ù„Ø·Ø¨Ø§Ø¹Ø© Ø³Ù„ÙŠÙ…Ø©)
            let styles = '';
            const allStyles = document.querySelectorAll('style, link[rel="stylesheet"]');
            allStyles.forEach(style => {
                if (style.tagName === 'STYLE') {
                    styles += `<style>${style.innerHTML}</style>`;
                } else if (style.href) {
                    styles += `<link rel="stylesheet" href="${style.href}">`;
                }
            });

            // 3. Ø¨Ù†Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            const printContent = `
                <html>
                <head>
                    <title>Ø·Ø¨Ø§Ø¹Ø© Ø¬Ø²Ø¡ Ù…Ø­Ø¯Ø¯</title>
                    <meta charset="UTF-8">
                    <style>
                        /* ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© */
                        .no-print { display: none !important; }
                        /* Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ø·Ø¨Ø§Ø¹Ø© Ù†Ø¸ÙŠÙØ© */
                        body { 
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            direction: rtl; 
                            background-color: white !important; 
                            padding: 20px; 
                        }
                        .editor-section { border: none !important; padding: 0 !important; }
                        /* Ø¥Ø¶Ø§ÙØ© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù†Øª Ù‡ÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø®ØµØµØ© */
                        .data-table th, .data-table td { border: 1px solid #000 !important; padding: 8px !important; }
                    </style>
                    ${styles}
                </head>
                <body dir="rtl">
                    <div style="max-width: 1000px; margin: 0 auto;">
                        ${content}
                    </div>
                </body>
                </html>
            `;

            // 4. ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØ·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø«Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
            printWindow.onload = function() {
                printWindow.print();
                printWindow.close();
            };
        }

        // ... (ØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù€ saveHTML Ùˆ downloadPDF ÙƒÙ…Ø§ Ù‡Ù…Ø§) ...
        function saveHTML() {
            const content = document.getElementById('printable-content').innerHTML;
            const fullHtml = `<html><head><title>Ù…Ø³ØªÙ†Ø¯ Ù…Ø­ÙÙˆØ¸</title><style>${document.querySelector('style').innerHTML}</style></head><body dir="rtl">${content}</body></html>`;
            const blob = new Blob([fullHtml], { type: 'text/html;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Ù…Ø³ØªÙ†Ø¯_Ù…Ø­Ø±Ø±_Ø´Ø§Ù…Ù„.html';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const content = document.getElementById('printable-content');
            
            const controls = document.querySelectorAll('.no-print');
            controls.forEach(c => c.style.display = 'none');
            
            const canvas = await html2canvas(content, { scale: 2, useCORS: true });
            controls.forEach(c => c.style.display = 'flex');

            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4'); 
            const imgWidth = 210; 
            const pageHeight = 297; 
            const imgHeight = canvas.height * imgWidth / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;

            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }

            pdf.save('Ù…Ø³ØªÙ†Ø¯_Ù…Ø­Ø±Ø±_Ø´Ø§Ù…Ù„.pdf');
        }
    </script>
</body>
</html>
